name: Web Tests

on:
  push:
  pull_request:

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: web/gui/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: web/gui

      - name: Typecheck
        run: npm run typecheck
        working-directory: web/gui

      - name: Lint
        run: npm run lint
        working-directory: web/gui

      - name: Unit tests
        run: npm test -- --passWithNoTests
        working-directory: web/gui

  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "web/backend/requirements.txt"

      - name: Install PyTorch CPU (required by modules.util.enum and config imports)
        run: pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Install dependencies
        run: pip install accelerate packaging -r web/backend/requirements.txt

      - name: Run tests
        run: >
          python -m pytest
          web/backend/tests/test_health.py
          web/backend/tests/test_config_api.py
          web/backend/tests/test_config_roundtrip.py
          web/backend/tests/test_parameter_parity.py
          web/backend/tests/test_training_method_rules.py
          -v

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: web/gui/package-lock.json

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Node dependencies
        run: npm ci
        working-directory: web/gui

      - name: Install Playwright
        run: npx playwright install --with-deps chromium
        working-directory: web/gui

      - name: Install PyTorch CPU (required by modules.util.enum and config imports)
        run: pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Install Python dependencies
        run: pip install accelerate packaging -r web/backend/requirements.txt

      - name: Start backend
        run: |
          python -m uvicorn web.backend.main:app --host 0.0.0.0 --port 8000 &
          for i in $(seq 1 30); do
            curl -sf http://localhost:8000/api/health && break || sleep 1
          done

      - name: Run E2E tests
        run: npm run test:e2e
        working-directory: web/gui
        env:
          API_URL: http://localhost:8000
